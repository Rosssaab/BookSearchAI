{% extends "base.html" %}

{% block extra_css %}
<style>
    .year-range-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
    }
    .year-display {
        font-weight: bold;
        text-align: center;
    }
    .all-years-checkbox {
        margin-top: 10px;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 300px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <h1 class="text-center mb-4">Ross's Demo AI Book Search</h1>
            <form id="searchForm">
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <th scope="row">
                                <label for="startYearInput" class="form-label">Start Year:</label>
                                <div class="all-years-checkbox">
                                    <input type="checkbox" class="form-check-input" id="allYearsCheckbox">
                                    <label class="form-check-label" for="allYearsCheckbox">All years</label>
                                </div>
                            </th>
                            <td>
                                <input type="range" class="form-range" id="startYearInput" name="start_year" min="1950" max="{{ current_year }}" value="1950">
                                <div class="year-range-labels">
                                    <span>1950</span>
                                    <span id="selectedStartYear" class="year-display">1950</span>
                                    <span>{{ current_year }}</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="endYearInput" class="form-label">End Year:</label></th>
                            <td>
                                <input type="range" class="form-range" id="endYearInput" name="end_year" min="1950" max="{{ current_year }}" value="{{ current_year }}">
                                <div class="year-range-labels">
                                    <span>1950</span>
                                    <span id="selectedEndYear" class="year-display">{{ current_year }}</span>
                                    <span>{{ current_year }}</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="authorInput" class="form-label">Author:</label></th>
                            <td><input type="text" class="form-control" id="authorInput" name="author" placeholder="Enter author name (optional)"></td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="titleInput" class="form-label">Title Contains:</label></th>
                            <td><input type="text" class="form-control" id="titleInput" name="title" placeholder="Enter part of the title (optional)"></td>
                        </tr>
                        <tr>
                            <th scope="row"><label class="form-label">Genres:</label></th>
                            <td>
                                <div class="row row-cols-3 g-2">
                                    {% for genre in genres %}
                                        <div class="col">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="{{ genre }}" name="genres" value="{{ genre }}">
                                                <label class="form-check-label" for="{{ genre }}">{{ genre }}</label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="text-center mt-3">
                    <button type="submit" id="searchButton" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>
    </div>
    <div id="results" class="mt-4"></div>
</div>

<!-- Modal -->
<div id="searchingModal" class="modal">
    <div class="modal-content">
        <p>Searching...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startYearInput = document.getElementById('startYearInput');
    const endYearInput = document.getElementById('endYearInput');
    const selectedStartYear = document.getElementById('selectedStartYear');
    const selectedEndYear = document.getElementById('selectedEndYear');
    const allYearsCheckbox = document.getElementById('allYearsCheckbox');
    const searchForm = document.getElementById('searchForm');
    const resultsDiv = document.getElementById('results');
    const searchButton = document.getElementById('searchButton');
    const searchingModal = document.getElementById('searchingModal');

    function updateYearDisplay() {
        if (allYearsCheckbox.checked) {
            selectedStartYear.textContent = 'All';
            startYearInput.disabled = true;
        } else {
            selectedStartYear.textContent = startYearInput.value;
            startYearInput.disabled = false;
        }
        selectedEndYear.textContent = endYearInput.value;

        // Ensure end year is not less than start year
        if (!allYearsCheckbox.checked && parseInt(endYearInput.value) < parseInt(startYearInput.value)) {
            endYearInput.value = startYearInput.value;
            selectedEndYear.textContent = startYearInput.value;
        }
    }

    startYearInput.addEventListener('input', updateYearDisplay);
    endYearInput.addEventListener('input', updateYearDisplay);
    allYearsCheckbox.addEventListener('change', updateYearDisplay);

    // Initialize
    updateYearDisplay();

    function displayResults(books) {
        resultsDiv.innerHTML = '';
        books.forEach(book => {
            const bookElement = document.createElement('div');
            bookElement.className = 'card mb-3';
            bookElement.innerHTML = `
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="${book.imageLinks?.thumbnail || 'placeholder.jpg'}" class="img-fluid rounded-start" alt="${book.title}">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title">${book.title}</h5>
                            <p class="card-text">Author(s): ${book.authors.join(', ')}</p>
                            <p class="card-text">Published: ${book.publishedDate}</p>
                            <p class="card-text">${book.description}</p>
                        </div>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(bookElement);
        });
        searchButton.textContent = 'New Search';
        searchButton.classList.remove('btn-primary');
        searchButton.classList.add('btn-secondary');
    }

    function resetSearch() {
        resultsDiv.innerHTML = '';
        searchButton.textContent = 'Search';
        searchButton.classList.remove('btn-secondary');
        searchButton.classList.add('btn-primary');
    }

    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (searchButton.textContent === 'New Search') {
            resetSearch();
        } else {
            const formData = new FormData(this);
            searchingModal.style.display = 'block';
            fetch('/search', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(books => {
                searchingModal.style.display = 'none';
                displayResults(books);
            })
            .catch(error => {
                console.error('Error:', error);
                searchingModal.style.display = 'none';
                resultsDiv.innerHTML = '<p>An error occurred while fetching results.</p>';
            });
        }
    });
});
</script>
{% endblock %}