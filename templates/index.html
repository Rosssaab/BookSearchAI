{% extends "base.html" %}

{% block extra_css %}
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 300px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .searching-gif {
        width: 100px;
        height: 100px;
        margin-bottom: 20px;
        animation: spin 2s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <h1 class="text-center mb-4">Ross's Demo AI Book Search</h1>
            <form id="searchForm">
                <div class="mb-3">
                    <label for="authorInput" class="form-label">Author:</label>
                    <input type="text" class="form-control" id="authorInput" name="author" placeholder="Enter author name (optional)">
                </div>
                <div class="mb-3">
                    <label for="titleInput" class="form-label">Title Contains:</label>
                    <input type="text" class="form-control" id="titleInput" name="title" placeholder="Enter part of the title (optional)">
                </div>
                <div class="text-center mt-3">
                    <button type="submit" id="searchButton" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>
    </div>
    <div id="results" class="mt-4"></div>
</div>

<!-- Modal -->
<div id="searchingModal" class="modal">
    <div class="modal-content">
        <img src="{{ url_for('static', filename='wait.gif') }}" alt="Searching..." class="searching-gif">
        <!-- Fallback SVG spinner -->
        <svg class="searching-gif" viewBox="0 0 50 50" style="display: none;">
            <circle cx="25" cy="25" r="20" fill="none" stroke="#000" stroke-width="5" />
        </svg>
        <p>Searching...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const resultsDiv = document.getElementById('results');
    const searchButton = document.getElementById('searchButton');
    const searchingModal = document.getElementById('searchingModal');

    function truncateText(text, limit) {
        const words = text.split(' ');
        if (words.length > limit) {
            return words.slice(0, limit).join(' ') + '...';
        }
        return text;
    }

    function displayResults(books) {
        resultsDiv.innerHTML = '';
        books.forEach(book => {
            const bookElement = document.createElement('div');
            bookElement.className = 'card mb-3';
            const truncatedDescription = truncateText(book.description, 50);
            bookElement.innerHTML = `
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="${book.imageLinks?.thumbnail || 'placeholder.jpg'}" class="img-fluid rounded-start" alt="${book.title}">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title">${book.title}</h5>
                            <p class="card-text">Author(s): ${book.authors.join(', ')}</p>
                            <p class="card-text">Published: ${book.publishedDate}</p>
                            <p class="card-text description">${truncatedDescription}</p>
                            ${book.description.split(' ').length > 50 ? '<a href="#" class="read-more">Read more</a>' : ''}
                        </div>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(bookElement);

            // Add event listener for "Read more" link
            const readMoreLink = bookElement.querySelector('.read-more');
            if (readMoreLink) {
                readMoreLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const descriptionElement = bookElement.querySelector('.description');
                    descriptionElement.textContent = book.description;
                    this.style.display = 'none';
                });
            }
        });
        searchButton.textContent = 'New Search';
        searchButton.classList.remove('btn-primary');
        searchButton.classList.add('btn-secondary');
    }

    function resetSearch() {
        resultsDiv.innerHTML = '';
        searchButton.textContent = 'Search';
        searchButton.classList.remove('btn-secondary');
        searchButton.classList.add('btn-primary');
    }

    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (searchButton.textContent === 'New Search') {
            resetSearch();
        } else {
            const formData = new FormData(this);
            const searchParams = new URLSearchParams(formData);
            searchingModal.style.display = 'block';
            console.log('Modal should be visible now'); // Debug: added console log

            // Debug: Check if the image is loaded
            const img = searchingModal.querySelector('img');
            const svg = searchingModal.querySelector('svg');
            img.onload = function() {
                console.log('Image loaded successfully');
                svg.style.display = 'none';
            };
            img.onerror = function() {
                console.error('Failed to load image');
                img.style.display = 'none';
                svg.style.display = 'block';
            };

            fetch('/search?' + searchParams.toString(), {
                method: 'GET'
            })
            .then(response => response.json())
            .then(books => {
                searchingModal.style.display = 'none';
                displayResults(books);
            })
            .catch(error => {
                console.error('Error:', error);
                searchingModal.style.display = 'none';
                resultsDiv.innerHTML = '<p>An error occurred while fetching results.</p>';
            });
        }
    });
});
</script>
{% endblock %}